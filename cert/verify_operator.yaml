---
# TODO need to ensure operaator

- name: Ensure 'operator-sdk' is installed
  get_url:  
    url: "https://github.com/operator-framework/operator-sdk/releases/download/{{release}}/operator-sdk-{{release}}-x86    _64-linux-gnu"
    dest: /usr/local/bin/operator-sdk
    mode: '0755'
  vars:
    release: "v0.10.0"

- name: Ensure 'python3' is installed
  yum:
    name: "{{packages}}"
  vars:
    packages:
        - python36
        - python36-pip

- name: Ensure 'operator-courier' is installed
  pip:
    name: operator-courier
    version: 2.0.1
    executable: pip3
        
- name: Set deploy directory facts
  set_fact:
    OLM_DIR: "deploy/olm-catalog/{{OPERATOR_NAME}}/{{OPERATOR_VERSION}}/"
    OLM_MANIFEST: "deploy/olm-catalog/{{OPERATOR_NAME}}/"
    CSI_CRD: "deploy/crds/ibm_v1alpha1_csiscaleoperator_crd.yaml" # TOOD Make inferred.

- name: Build operator 'ClusterServiceVersion'
  shell: "operator-sdk olm-catalog gen-csv --operator-name {{OPERATOR_NAME}} --csv-version {{OPERATOR_VERSION}} --update-crds"
  args:
    chdir: "{{OPERATOR_DIR}}"
  environment:
    GO111MODULE: on

- name: "Split '{{item}}' into OLM directory"
  shell: "python hacks/split_yaml.py -f {{item}} -d {{dest}}"
  args:
    chdir: "{{OPERATOR_DIR}}"
  vars:
    dest: "{{OLM_DIR}}"
  loop:
    - "deploy/service_account.yaml"
    -  "deploy/role_binding.yaml"

- name: "Copy details from CRD {{item}} into CSV"
  shell: "python hacks/copy_crd_descriptions.py --crd {{item}} --csv  {{dest}}"
  args:
    chdir: "{{OPERATOR_DIR}}"
  vars:
    dest: "{{OLM_DIR}}"
  loop:
    - "{{CSI_CRD}}"

- name: Run the 'operator-courier'
  shell: "operator-courier verify --ui_validate_io {{OLM_MANIFEST}}"
  args:
    chdir: "{{OPERATOR_DIR}}" 

- name: Run 'operator-sdk' scorecard
  shell: "operator-sdk scorecard {{SC_VARS}}"
  args:
    chdir: "{{OPERATOR_DIR}}"
  environment:
    GO111MODULE: on
  

